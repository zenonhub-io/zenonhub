import:
- deploy/main.php

tasks:
  deploy:
    - deploy:prepare
    - deploy:vendors
    - npx:build:production
    - npx:build:cleanup
    - artisan:storage:link
    - artisan:down
    - artisan:migrate
    - deploy:publish
    - artisan:horizon:terminate
    - artisan:queue:restart
    - artisan:schedule:interrupt
    - artisan:config:cache
    - artisan:event:cache
    - artisan:route:cache
    - artisan:view:cache
    - artisan:nom:update-contract-methods
    - artisan:nom:update-named-addresses
    - artisan:sync:bridge-status
    - artisan:sync:orchestrators
    - artisan:sync:pillar-metrics
    - artisan:sync:public-nodes
    - artisan:site:generate-sitemap
    - artisan:up
  artisan:schedule:interrupt:
    - run: '{{bin/php}} {{release_or_current_path}}/artisan schedule:interrupt'
  artisan:nom:update-contract-methods:
    - run: '{{bin/php}} {{release_or_current_path}}/artisan nom:update-contract-methods'
  artisan:nom:update-named-addresses:
    - run: '{{bin/php}} {{release_or_current_path}}/artisan nom:update-named-addresses'
  artisan:sync:bridge-status:
    - run: '{{bin/php}} {{release_or_current_path}}/artisan sync:bridge-status'
  artisan:sync:orchestrators:
    - run: '{{bin/php}} {{release_or_current_path}}/artisan sync:orchestrators'
  artisan:sync:public-nodes:
    - run: '{{bin/php}} {{release_or_current_path}}/artisan sync:public-nodes'
  artisan:sync:pillar-metrics:
    - run: '{{bin/php}} {{release_or_current_path}}/artisan sync:pillar-metrics'
  artisan:site:generate-sitemap:
    - run: '{{bin/php}} {{release_or_current_path}}/artisan site:generate-sitemap'
  npx:build:production:
    - run: 'cd {{release_or_current_path}} && npm ci && npm run production'
  npx:build:cleanup:
    - run: 'cd {{release_or_current_path}} && rm -r node_modules'

after:
  deploy:failed: deploy:unlock
